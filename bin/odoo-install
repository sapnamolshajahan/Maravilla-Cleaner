#!/usr/bin/env bash
#set -x
#
# Install modules
#
VENV="odoo19"

showUsage ()
{
	echo "Usage: $(basename $0) configfile dbname module[,module1,module2..]"
}

vWrapper ()
{
	for D in /usr/local/bin /usr/share/virtualenvwrapper
	do
		W="${D}/virtualenvwrapper.sh"
		if [ -r ${W} ]
		then
			VWRAPPER=${W}
			break
		fi
	done
	if [ -z "${VWRAPPER}" ]
	then
		echo "ERROR: virtualenvwrapper.sh not found"
		exit 1
	fi
	source ${VWRAPPER}
}

#
# Determine Paths
#
DIRNAME=$(dirname ${0})
RELEASE_BASE=$(realpath ${DIRNAME}/..)

#
# Validate arguments
#
if [ $# -ne 3 ]
then
	showUsage
	exit 1
fi

#
# Release configuration
#
CONFIG_SH="${HOME}/release-config.sh"
if [ ! -r ${CONFIG_SH} ]
then
	echo "ERROR: ${CONFIG_SH} not found."
	echo '- Create a link to the customer release-config.sh from ${HOME}'
	exit 1
fi
. ${CONFIG_SH}

#
# Validate virtualenvs
#
WORKON_HOME="$(eval echo ~${RELEASE_USER}/virtualenvs)"
if [ ! -d "${WORKON_HOME}/${VENV}" ]
then
	echo "ERROR: WORKON_HOME/${VENV} does not exist"
	exit 1
fi

for C in "${HOME}/etc/${1}.rc" "${RELEASE_BASE}/customer/${RELEASE_CUSTOMER}/${1}.rc"
do
	if [ -r ${C} ]
	then
		CONFIG=${C}
	fi
done
if [ -z "${CONFIG}" ]
then
	echo "ERROR: Configuration file ${1}.rc not found"
	exit 1
fi
shift

#
# Validate run environment
#
if [ ${RELEASE_USER} != $(id -un) ]
then
	echo "ERROR: need to run upgrade as '${RELEASE_USER}'"
	exit 1
fi
if [ ! -f bin/odoo-install ]
then
	echo "ERROR: need to run script from top-level"
	exit 1
fi

DBNAME="${1}"
BUNDLE="${2}"

export WORKON_HOME
vWrapper
workon ${VENV}

odoo/odoo-bin -c ${CONFIG} -d ${DBNAME} --init ${BUNDLE} --stop-after-init --no-http
